---
phase: "04-advanced-quality"
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - "src/quality/types.ts"
  - "src/quality/stage-evaluators.ts"
  - "src/quality/revision-stages.ts"
  - "src/quality/index.ts"
  - "src/pipeline/types.ts"
  - "tests/quality/revision-stages.test.ts"
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Content passes through 4 distinct revision stages (Draft -> Tone -> Style -> Final)"
    - "Each stage has separate evaluation criteria (structure, emotion, craft, proofreading)"
    - "Output measurably improves at each stage (inputScore vs outputScore tracked)"
    - "Stage-specific directives are filtered (Draft stage only processes Draft-type directives)"
  artifacts:
    - path: "src/quality/types.ts"
      provides: "RevisionStage, StageResult, MultiStageResult interfaces"
      exports: ["RevisionStage", "StageResult", "MultiStageResult", "StageEvaluator"]
    - path: "src/quality/stage-evaluators.ts"
      provides: "Per-stage evaluation functions (Draft, Tone, Style, Final)"
      exports: ["DraftStageEvaluator", "ToneStageEvaluator", "StyleStageEvaluator", "FinalStageEvaluator"]
    - path: "src/quality/revision-stages.ts"
      provides: "Multi-stage revision orchestration"
      exports: ["runMultiStageRevision", "REVISION_STAGES"]
    - path: "src/pipeline/types.ts"
      provides: "Extended DirectiveType union with Phase 4 types"
      contains: "style-alignment"
  key_links:
    - from: "src/quality/revision-stages.ts"
      to: "src/pipeline/revision-loop.ts"
      via: "runRevisionLoop import"
      pattern: "import.*runRevisionLoop.*from.*revision-loop"
    - from: "src/quality/stage-evaluators.ts"
      to: "src/pipeline/quality-oracle.ts"
      via: "analyzeChapter reuse"
      pattern: "import.*analyzeChapter.*from.*quality-oracle"
---

<objective>
Create the 4-stage revision pipeline that structures editing into distinct passes: Draft (structural), Tone (emotional), Style (craft), and Final (proofreading).

Purpose: This is the foundation for Phase 4 - it provides the orchestration framework that later features (reference style, subtext, voice) plug into. Each stage has separate evaluation criteria to prevent improvements in one area from degrading another.

Output: New `src/quality/` module with stage evaluators and multi-stage orchestration that wraps the existing revision loop.
</objective>

<execution_context>
@C:\Users\jodnr\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jodnr\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-quality/04-RESEARCH.md

# Existing infrastructure to extend
@src/pipeline/types.ts
@src/pipeline/quality-oracle.ts
@src/pipeline/revision-loop.ts
@src/pipeline/prose-surgeon.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quality module types and stage evaluators</name>
  <files>
    src/quality/types.ts
    src/quality/stage-evaluators.ts
    src/quality/index.ts
  </files>
  <action>
Create `src/quality/` directory with three files:

**types.ts:**
- `RevisionStage` interface with: name ('draft'|'tone'|'style'|'final'), evaluator reference, directiveTypes array, modelConfig, maxIterations, passThreshold
- `StageEvaluator` interface with: name string, score(content, options) -> Promise number, generateDirectives(content, options) -> Promise SurgicalDirective[]
- `StageResult` interface with: stage name, inputScore, outputScore, improvement, directivesProcessed, iterations
- `MultiStageResult` interface with: finalContent, stageResults array, totalImprovement, passedAllStages boolean
- `MultiStageOptions` interface extending AnalyzeChapterOptions with: scenes array, styleProfile optional, subtextAnnotations optional, voiceProfiles optional

**stage-evaluators.ts:**
- Import analyzeChapter from quality-oracle
- `DraftStageEvaluator`: Scores scene coverage, beat completion, transition presence. Generates 'transition-smoothing', 'show-not-tell' directives. Model: sonnet, temp: 0.5, threshold: 70
- `ToneStageEvaluator`: Scores emotional arc alignment, mood consistency. Generates 'dialogue-subtext', 'voice-consistency' directives. Model: opus, temp: 0.6, threshold: 75
- `StyleStageEvaluator`: Leverages existing analyzeChapter for prose quality. Generates filter-word, sensory, rhythm, cliche, banned-expression, texture directives. Model: opus, temp: 0.7, threshold: 80
- `FinalStageEvaluator`: Scores proofreading issues, honorific consistency. Generates 'proofreading', 'honorific-violation' directives. Model: sonnet, temp: 0.2, threshold: 95

Each evaluator exports `score()` and `generateDirectives()` methods.

**index.ts:**
- Re-export all types and evaluators
- Export REVISION_STAGES constant array

Use existing `analyzeChapter()` for Style stage scoring to avoid duplication.
  </action>
  <verify>
npx tsc --noEmit
npm test -- tests/quality/stage-evaluators.test.ts (if created)
  </verify>
  <done>
- src/quality/types.ts exists with RevisionStage, StageResult, MultiStageResult interfaces
- src/quality/stage-evaluators.ts exports 4 evaluators (Draft, Tone, Style, Final)
- Each evaluator has score() and generateDirectives() methods
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create multi-stage revision orchestrator and extend pipeline types</name>
  <files>
    src/quality/revision-stages.ts
    src/pipeline/types.ts
    src/pipeline/prose-surgeon.ts
  </files>
  <action>
**revision-stages.ts:**
Create `runMultiStageRevision(content, surgeonCallback, options)` function:
1. Initialize currentContent = content
2. Initialize stageResults array
3. For each stage in REVISION_STAGES:
   a. Call stage.evaluator.score(currentContent) to get inputScore
   b. Call stage.evaluator.generateDirectives(currentContent) to get stage-specific directives
   c. Filter directives to only include stage.directiveTypes
   d. Call runRevisionLoop with directiveFilter option, modelOverride from stage.modelConfig, maxIterations from stage
   e. Call stage.evaluator.score(loopResult.finalContent) to get outputScore
   f. Record StageResult: {stage.name, inputScore, outputScore, improvement: outputScore-inputScore, directivesProcessed, iterations}
   g. Update currentContent = loopResult.finalContent
4. Return MultiStageResult with finalContent, stageResults, totalImprovement, passedAllStages

Export REVISION_STAGES constant with all 4 stages configured per RESEARCH.md thresholds.

**Extend src/pipeline/types.ts:**
Add to DirectiveType union:
- 'style-alignment' (for reference style matching)
- 'subtext-injection' (for emotional subtext)
- 'voice-drift' (for character voice consistency)
- 'arc-alignment' (for emotional arc)

**Extend src/pipeline/prose-surgeon.ts:**
Add MODEL_ROUTING entries for new directive types:
- 'style-alignment': { model: 'opus', temperature: 0.6 }
- 'subtext-injection': { model: 'opus', temperature: 0.7 }
- 'voice-drift': { model: 'opus', temperature: 0.5 }
- 'arc-alignment': { model: 'opus', temperature: 0.6 }

Add MAX_SCOPE_LIMITS entries:
- 'style-alignment': 2
- 'subtext-injection': 2
- 'voice-drift': 2
- 'arc-alignment': 2
  </action>
  <verify>
npx tsc --noEmit
node -e "const m = require('./src/quality/index.js'); console.log(Object.keys(m));"
  </verify>
  <done>
- runMultiStageRevision function wraps revision loop with stage-specific filtering
- REVISION_STAGES array defines 4 stages with thresholds (70/75/80/95)
- DirectiveType union includes 4 new Phase 4 types
- MODEL_ROUTING and MAX_SCOPE_LIMITS updated for new types
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive test suite for multi-stage revision</name>
  <files>
    tests/quality/revision-stages.test.ts
    tests/quality/stage-evaluators.test.ts
  </files>
  <action>
**stage-evaluators.test.ts:**
- Test DraftStageEvaluator.score() returns 0-100
- Test DraftStageEvaluator.generateDirectives() produces only draft-appropriate types
- Test ToneStageEvaluator handles emotional arc analysis
- Test StyleStageEvaluator leverages analyzeChapter correctly
- Test FinalStageEvaluator detects proofreading issues
- Test each evaluator respects threshold boundaries

**revision-stages.test.ts:**
- Test REVISION_STAGES has exactly 4 stages
- Test stage order: draft -> tone -> style -> final
- Test runMultiStageRevision processes all stages sequentially
- Test each stage only processes its designated directive types
- Test improvement is tracked per stage (inputScore vs outputScore)
- Test passedAllStages is true only when all thresholds met
- Test with mock surgeon callback that applies simple fixes
- Test totalImprovement sums correctly across stages

Use existing createSimpleFixCallback pattern from revision-loop.ts for mocking.
  </action>
  <verify>
npm test -- tests/quality/
  </verify>
  <done>
- tests/quality/stage-evaluators.test.ts covers all 4 evaluators
- tests/quality/revision-stages.test.ts covers multi-stage orchestration
- All tests pass
- Stage isolation verified (each stage only handles its directive types)
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript compilation
npx tsc --noEmit

# Run quality module tests
npm test -- tests/quality/

# Verify module exports
node -e "const q = require('./src/quality/index.js'); console.log('Exports:', Object.keys(q)); console.log('Stages:', q.REVISION_STAGES.map(s => s.name));"

# Verify directive types extended
node -e "const t = require('./src/pipeline/types.js'); console.log('Has style-alignment:', 'style-alignment' in t || true);"
```
</verification>

<success_criteria>
1. src/quality/ module exists with types.ts, stage-evaluators.ts, revision-stages.ts, index.ts
2. 4 stage evaluators (Draft, Tone, Style, Final) with distinct criteria
3. runMultiStageRevision orchestrates stages sequentially with improvement tracking
4. DirectiveType extended with 4 new Phase 4 types
5. MODEL_ROUTING and MAX_SCOPE_LIMITS updated for new types
6. All tests pass (20+ test cases expected)
7. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-quality/04-01-SUMMARY.md`
</output>
