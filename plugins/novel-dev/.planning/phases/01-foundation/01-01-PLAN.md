---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - schemas/style-library.schema.json
  - src/types.ts
  - src/style-library/types.ts
  - src/style-library/storage.ts
  - src/style-library/retrieval.ts
  - src/style-library/classifier.ts
  - src/style-library/index.ts
  - agents/style-curator.md
  - skills/style-library/SKILL.md
  - commands/style-library.md
  - templates/style-library/default-exemplars.json
  - tests/style-library/storage.test.ts
  - tests/style-library/retrieval.test.ts
autonomous: true

must_haves:
  truths:
    - "User can store a new prose exemplar with genre, scene_type, emotional_tone tags"
    - "User can retrieve exemplars matching a given genre + scene_type query"
    - "Anti-exemplar pairs are linked by ID and retrievable together"
    - "Default curated exemplars exist after project initialization"
  artifacts:
    - path: "schemas/style-library.schema.json"
      provides: "JSON Schema validation for exemplar storage"
      contains: "exm_"
    - path: "src/style-library/storage.ts"
      provides: "CRUD operations for exemplars"
      exports: ["addExemplar", "removeExemplar", "updateExemplar", "loadLibrary", "saveLibrary"]
    - path: "src/style-library/retrieval.ts"
      provides: "Query-based exemplar retrieval with scoring"
      exports: ["queryExemplars"]
    - path: "src/style-library/types.ts"
      provides: "StyleExemplar, ExemplarQuery, ExemplarResult types"
      exports: ["StyleExemplar", "ExemplarQuery", "ExemplarResult"]
    - path: "agents/style-curator.md"
      provides: "Agent definition for exemplar curation"
    - path: "templates/style-library/default-exemplars.json"
      provides: "Starter exemplars for each genre"
  key_links:
    - from: "src/style-library/retrieval.ts"
      to: "src/style-library/storage.ts"
      via: "loadLibrary call"
      pattern: "loadLibrary"
    - from: "src/style-library/retrieval.ts"
      to: "src/style-library/types.ts"
      via: "StyleExemplar type import"
      pattern: "import.*StyleExemplar"
    - from: "schemas/style-library.schema.json"
      to: "src/style-library/types.ts"
      via: "TypeScript types mirror JSON Schema"
      pattern: "StyleExemplar"
---

<objective>
Build the Style Library infrastructure: JSON schema, TypeScript types, file-based storage, multi-dimensional retrieval, and a style-curator agent for exemplar management.

Purpose: Few-shot exemplars are the highest-ROI technique for prose quality (EMNLP 2025). This plan creates the storage and retrieval system that Phase 2's writing pipeline will consume. Without this, writing agents have no style reference.

Output: A complete style library module with schema validation, CRUD storage, scored retrieval, anti-exemplar pairing, curated defaults, and a `/style-library` command for management.
</objective>

<execution_context>
@C:\Users\jodnr\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jodnr\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

Key existing files to understand patterns:
@src/types.ts
@src/context/types.ts
@schemas/chapter.schema.json
@schemas/style-guide.schema.json
@templates/chapter.template.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Style Library schema, types, and storage module</name>
  <files>
    schemas/style-library.schema.json
    src/style-library/types.ts
    src/style-library/storage.ts
    src/style-library/classifier.ts
    src/style-library/index.ts
    src/types.ts
  </files>
  <action>
1. Create `schemas/style-library.schema.json` (JSON Schema draft-07) following the exact pattern from RESEARCH.md:
   - Required fields: id (pattern `^exm_[a-z0-9_]+$`), content (500-2000 chars, minLength 500 per locked decision: exemplar length must be scene-level 500~1500 chars), genre (string array, minItems 1), scene_type (enum: opening-hook, dialogue, action, emotional-peak, transition, description, climax, denouement), is_anti_exemplar (boolean), source (string)
   - Optional fields: emotional_tone (string array), pov (enum: first-person, third-limited, third-omniscient), pacing (enum: fast, medium, slow), anti_exemplar_pair (string), quality_notes (string), language_features (string array), created_at (date-time)
   - Top-level: `{ exemplars: [...], metadata: { version, total_exemplars, genres_covered, last_updated } }`
   - Follow existing schema conventions: `$schema`, `$id`, `title`, `description` fields
   - IMPORTANT: content minLength MUST be 500 (not 300). Locked decision: "exemplar 길이: 장면 단위 (500~1500자)"

2. Create `src/style-library/types.ts` with TypeScript interfaces:
   - `StyleExemplar` interface matching all schema fields (14 fields per RESEARCH.md)
   - `StyleLibrary` interface: `{ exemplars: StyleExemplar[], metadata: StyleLibraryMetadata }`
   - `StyleLibraryMetadata`: `{ version: string, total_exemplars: number, genres_covered: string[], last_updated: string }`
   - `ExemplarCategory` type with the 5-dimension taxonomy: genre, scene_type, emotional_tone, pov, pacing
   - `ExemplarQuery` interface: genre, scene_type, emotional_tone?, pov?, pacing?, limit? (default 3), include_anti? (default true)
   - `ExemplarResult` interface: exemplars (StyleExemplar[]), anti_exemplar? (StyleExemplar), total_tokens (number)

3. Create `src/style-library/storage.ts`:
   - `loadLibrary(projectDir: string): Promise<StyleLibrary>` -- reads `meta/style-library.json` from project dir. If not found, returns empty library with metadata.
   - `saveLibrary(projectDir: string, library: StyleLibrary): Promise<void>` -- writes to `meta/style-library.json`, updates metadata.total_exemplars and metadata.last_updated
   - `addExemplar(library: StyleLibrary, exemplar: Omit<StyleExemplar, 'id' | 'created_at'>): StyleLibrary` -- generates ID (exm_{genre[0]}_{NNN}), sets created_at, adds to array, returns new library
   - `removeExemplar(library: StyleLibrary, id: string): StyleLibrary` -- removes by ID, also removes anti_exemplar_pair references
   - `updateExemplar(library: StyleLibrary, id: string, updates: Partial<StyleExemplar>): StyleLibrary` -- partial update
   - Use `fs/promises` for file I/O. Follow the pattern from existing `src/state/` module.
   - Do NOT use Zod for validation (project has it in deps but existing code uses JSON Schema validation pattern)

4. Create `src/style-library/classifier.ts`:
   - `classifyExemplar(content: string, hints?: Partial<ExemplarCategory>): ExemplarCategory` -- determines category dimensions from content and optional hints. Returns the 5 dimensions. For dimensions not in hints, set reasonable defaults based on content analysis (e.g., detect dialogue markers for scene_type "dialogue", detect action verbs for "action", etc.)
   - This is a heuristic classifier, not ML. Keep it simple -- keyword matching and pattern detection for Korean text.

5. Create `src/style-library/index.ts` -- re-exports all public APIs from types, storage, retrieval

6. Add to `src/types.ts`: Import and re-export `StyleExemplar`, `SceneV5` types (add SceneV5 placeholder comment for Plan 01-03). Add `Pacing` type alias if not already exported.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `schemas/style-library.schema.json` is valid JSON
    - `npm run validate:schemas` passes (existing schema validation script)
    - Verify content field in schema has minLength: 500 (not 300)
  </verify>
  <done>
    - StyleExemplar type has all 14 fields matching the JSON schema
    - Schema enforces content minLength of 500 chars (locked decision)
    - Storage module provides loadLibrary, saveLibrary, addExemplar, removeExemplar, updateExemplar
    - Classifier provides heuristic categorization for Korean text
    - All types exported from src/style-library/index.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Retrieval engine, agent, command, defaults, and tests</name>
  <files>
    src/style-library/retrieval.ts
    agents/style-curator.md
    skills/style-library/SKILL.md
    commands/style-library.md
    templates/style-library/default-exemplars.json
    tests/style-library/storage.test.ts
    tests/style-library/retrieval.test.ts
  </files>
  <action>
1. Create `src/style-library/retrieval.ts`:
   - `queryExemplars(library: StyleLibrary, query: ExemplarQuery): ExemplarResult`
   - Scoring algorithm: For each non-anti exemplar, calculate match score:
     * genre match: +10 per matching genre (query.genre in exemplar.genre array)
     * scene_type exact match: +20
     * emotional_tone match: +5 per matching tone
     * pov match: +8
     * pacing match: +5
   - Sort by score descending, take top N (query.limit, default 3)
   - Anti-exemplar selection: If query.include_anti (default true), find the highest-scoring anti-exemplar. If it has an anti_exemplar_pair pointing to a good exemplar already in results, prefer it.
   - Calculate total_tokens using the estimator from `src/context/estimator.ts` (import estimateTokens)
   - Cap at 4 exemplars total (2-3 good + 0-1 anti) per RESEARCH.md guidance

2. Create `agents/style-curator.md`:
   - Follow the exact markdown format of existing agents (e.g., `agents/novelist.md`)
   - Role: Curates, categorizes, and manages style exemplars
   - Capabilities: Add exemplars from user-provided text, auto-classify using 5-dimension taxonomy, create anti-exemplar pairs, suggest exemplars from existing novel passages
   - Instructions: Always tag with at least genre and scene_type. Content must be 500-1500 chars (scene-length). Include quality_notes explaining why the exemplar is good/bad. Korean language features should be explicitly tagged.

3. Create `skills/style-library/SKILL.md`:
   - Skill definition following existing skill patterns (check any existing skill dir for format)
   - Actions: add (add new exemplar), list (list by category), search (query exemplars), remove (delete exemplar), import (bulk import from text), stats (show library statistics)
   - Each action references the style-curator agent

4. Create `commands/style-library.md`:
   - Command number: 20 (next after existing 19)
   - Command definition following existing command format (check `commands/14-write.md`)
   - Subcommands: `/style-library add`, `/style-library list [genre]`, `/style-library search <query>`, `/style-library remove <id>`, `/style-library stats`

5. Create `templates/style-library/default-exemplars.json`:
   - Provide 6-8 curated Korean prose exemplars covering:
     * romance opening-hook (1 good + 1 anti-exemplar pair showing AI-style vs natural)
     * fantasy action scene (1 good)
     * dialogue scene with distinct character voices (1 good + 1 anti showing flat dialogue)
     * emotional-peak with sensory grounding (1 good)
     * transition scene (1 good)
   - Each exemplar: 500-1500 chars of Korean prose
   - Anti-exemplars demonstrate common AI writing patterns (excessive "한편", "그러나", tell-don't-show)
   - Quality notes in Korean explaining what makes each exemplar good or bad
   - Format: valid against style-library.schema.json

6. Create `tests/style-library/storage.test.ts` (Vitest):
   - Test addExemplar: generates correct ID, sets created_at
   - Test removeExemplar: removes exemplar and cleans anti_exemplar_pair refs
   - Test updateExemplar: partial update works
   - Test loadLibrary/saveLibrary: round-trip file I/O (use temp dir)

7. Create `tests/style-library/retrieval.test.ts` (Vitest):
   - Test queryExemplars with exact genre+scene_type match returns top results
   - Test scoring: genre match scores higher than tone match
   - Test anti-exemplar inclusion: returns at most 1 anti-exemplar
   - Test limit parameter: respects max results
   - Test empty library returns empty result
  </action>
  <verify>
    - `npx vitest run tests/style-library/` passes all tests
    - `npx tsc --noEmit` passes
    - `templates/style-library/default-exemplars.json` is valid JSON
    - Default exemplars contain at least 6 entries with Korean prose content
  </verify>
  <done>
    - queryExemplars returns scored, ranked exemplars with anti-exemplar support
    - style-curator agent defined with curation capabilities
    - /style-library command provides add/list/search/remove/stats subcommands
    - Default exemplars cover 3+ genres with anti-exemplar pairs
    - All tests pass
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors (TypeScript compilation)
2. `npm run validate:schemas` passes (includes new style-library schema)
3. `npx vitest run tests/style-library/` -- all storage and retrieval tests pass
4. `templates/style-library/default-exemplars.json` validates against `schemas/style-library.schema.json`
</verification>

<success_criteria>
- Style Library schema validates exemplar data with 5-dimension taxonomy
- Schema enforces content minLength of 500 chars (locked decision: scene-level exemplars)
- CRUD storage reads/writes from project `meta/style-library.json`
- Retrieval scores and ranks exemplars by multi-dimensional match quality
- Anti-exemplar pairs are linked and retrievable together
- Default curated exemplars (6-8) ship with the plugin for immediate use
- style-curator agent and /style-library command are defined
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
