---
phase: 01-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - schemas/scene.schema.json
  - src/types.ts
  - src/scene/types.ts
  - src/scene/decomposer.ts
  - src/scene/validator.ts
  - src/scene/index.ts
  - tests/scene/decomposer.test.ts
autonomous: true

must_haves:
  truths:
    - "A chapter with plot beats can be decomposed into 2-5 SceneV5 objects"
    - "Each scene has pov_character, sensory_anchors, emotional_arc, and foreshadowing fields"
    - "Existing chapter.schema.json scenes remain valid (backward compatible superset)"
    - "Scenes under 800 chars trigger merging with adjacent scenes"
  artifacts:
    - path: "schemas/scene.schema.json"
      provides: "JSON Schema for enriched scene data model"
      contains: "sensory_anchors"
    - path: "src/scene/decomposer.ts"
      provides: "Chapter-to-scenes decomposition from plot beats"
      exports: ["decomposeChapter"]
    - path: "src/scene/types.ts"
      provides: "SceneV5, EmotionalArc, SceneTransition types"
      exports: ["SceneV5", "EmotionalArc", "SceneTransition", "DecompositionResult"]
    - path: "src/scene/validator.ts"
      provides: "Scene validation and constraint checking"
      exports: ["validateScenes"]
  key_links:
    - from: "src/scene/decomposer.ts"
      to: "src/types.ts"
      via: "ChapterMeta import for input"
      pattern: "import.*ChapterMeta"
    - from: "src/scene/types.ts"
      to: "src/types.ts"
      via: "extends existing Scene interface"
      pattern: "extends Scene"
    - from: "schemas/scene.schema.json"
      to: "schemas/chapter.schema.json"
      via: "superset of existing scenes items schema"
      pattern: "scene_number"
---

<objective>
Build the Scene Data Model: an enriched scene schema that extends the existing chapter scenes with POV, sensory anchors, emotional arcs, foreshadowing, and transitions. Create decomposition logic that transforms chapter plot beats into SceneV5 objects.

Purpose: Phase 2's scene-based writing pipeline requires discrete scene objects with enough detail for independent drafting. Without this data model, scenes cannot be drafted independently while maintaining narrative coherence.

Output: Scene JSON schema, TypeScript types, chapter decomposer (plot beats -> scenes), validator, and tests.
</objective>

<execution_context>
@C:\Users\jodnr\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jodnr\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

Key existing files:
@src/types.ts
@schemas/chapter.schema.json
@schemas/emotional-context.schema.json
@schemas/foreshadowing.schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scene schema, types, and decomposition module</name>
  <files>
    schemas/scene.schema.json
    src/scene/types.ts
    src/scene/decomposer.ts
    src/scene/validator.ts
    src/scene/index.ts
    src/types.ts
  </files>
  <action>
1. Create `schemas/scene.schema.json` (JSON Schema draft-07):
   - Follow existing schema conventions ($schema, $id, title, description)
   - Must be a SUPERSET of the existing scenes items in chapter.schema.json
   - Existing required fields (all preserved): scene_number, purpose, characters, location, conflict, beat
   - Existing optional field: emotional_tone, estimated_words
   - NEW optional fields (all optional for backward compatibility):
     * pov_character (string) -- character ID for scene POV
     * sensory_anchors (array of strings, minItems 2 when present) -- required sensory details
     * emotional_arc (object): entry_emotion (string), exit_emotion (string), peak_moment (string), tension_target (integer 1-10)
     * dialogue_goals (array of strings) -- what dialogue must accomplish
     * foreshadowing (object): plant (array of fore_XXX IDs), payoff (array), hint (array)
     * transition (object): from_previous (string), to_next (string)
     * style_override (object): pacing (enum fast/medium/slow), focus (string), tone (string)
     * exemplar_tags (array of strings) -- for matching style exemplars to this scene
   - All new fields are in additionalProperties or optional, so old chapter JSONs validate fine

2. Create `src/scene/types.ts`:
   - `EmotionalArc` interface: { entry_emotion: string, exit_emotion: string, peak_moment: string, tension_target: number }
   - `SceneForeshadowing` interface: { plant: string[], payoff: string[], hint: string[] }
   - `SceneTransition` interface: { from_previous: string, to_next: string }
   - `SceneStyleOverride` interface: { pacing: Pacing, focus: string, tone: string }
   - `SceneV5` interface extending existing `Scene` from src/types.ts:
     * All existing Scene fields (scene_number, purpose, characters, location, conflict, beat)
     * pov_character: string
     * sensory_anchors: string[]
     * emotional_arc: EmotionalArc
     * dialogue_goals?: string[]
     * foreshadowing: SceneForeshadowing
     * transition: SceneTransition
     * style_override?: SceneStyleOverride
     * exemplar_tags?: string[]
   - `DecompositionConfig` interface: { min_scene_chars: number (default 800), max_scenes: number (default 5), merge_threshold: number (default 600) }
   - `DecompositionResult` interface: { scenes: SceneV5[], warnings: string[], original_beat_count: number }

3. Create `src/scene/decomposer.ts`:
   - `decomposeChapter(chapter: ChapterMeta, config?: Partial<DecompositionConfig>): DecompositionResult`
   - Algorithm:
     a. Read chapter.context.current_plot (the 2000-8000 char plot text)
     b. Parse existing chapter.scenes array as base (these have scene_number, purpose, characters, location, conflict, beat)
     c. For each existing scene, ENRICH with new SceneV5 fields:
        - pov_character: default to chapter.meta.pov_character (can be overridden per scene if plot suggests POV shift)
        - sensory_anchors: derive from location and scene type (at least 2: e.g., sight + sound for action, sight + smell for description)
        - emotional_arc: derive entry_emotion from previous scene's exit (or "neutral" for first), exit_emotion from beat content, peak_moment from conflict, tension_target from pacing
        - foreshadowing: match chapter.narrative_elements foreshadowing_plant/payoff to scenes by checking which beat/conflict involves which foreshadowing
        - transition: from_previous (first scene: "chapter opening"; others: derive from emotional arc shift), to_next (last scene: "chapter ending hook"; others: derive from next scene's entry)
        - exemplar_tags: derive from scene_type detection in beat text (look for dialogue markers, action verbs, emotional keywords)
     d. If chapter has fewer scenes than beats suggest, split scenes. If a scene's estimated_words > 2x average, consider splitting.
     e. Merge scenes that would be under min_scene_chars (default 800) with adjacent scene
     f. Cap at max_scenes (default 5); if more, merge least-important adjacent scenes
     g. Re-number scenes sequentially after any splits/merges
   - This is a DATA ENRICHMENT function, not an LLM call. It uses heuristics and the existing chapter metadata to fill in the new fields. Phase 2 will have agents that refine these.

4. Create `src/scene/validator.ts`:
   - `validateScenes(scenes: SceneV5[]): { valid: boolean, errors: string[], warnings: string[] }`
   - Checks:
     * scene_number is sequential starting from 1
     * sensory_anchors has at least 2 items per scene
     * emotional_arc.tension_target is 1-10
     * foreshadowing IDs follow fore_XXX pattern
     * No duplicate scene_numbers
     * Total scenes between 1 and 6
     * transition.from_previous exists for scenes > 1
     * transition.to_next exists for scenes < last

5. Create `src/scene/index.ts` -- re-exports decomposeChapter, validateScenes, and all types

6. Update `src/types.ts`:
   - Import and re-export SceneV5 from src/scene/types.ts
   - Keep existing Scene interface unchanged (SceneV5 extends it)
   - Ensure Pacing type is exported (already exists as utility type)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `schemas/scene.schema.json` is valid JSON
    - `npm run validate:schemas` passes
    - Existing chapter.schema.json scenes still validate (backward compatible)
  </verify>
  <done>
    - SceneV5 extends existing Scene with 8 new field groups
    - All new fields are optional in schema (backward compatible)
    - Decomposer enriches existing chapter scenes with v5 fields using heuristics
    - Validator checks scene constraints (2+ sensory anchors, sequential numbers, tension range)
  </done>
</task>

<task type="auto">
  <name>Task 2: Decomposer tests and schema validation</name>
  <files>
    tests/scene/decomposer.test.ts
  </files>
  <action>
1. Create `tests/scene/decomposer.test.ts` (Vitest):

Test cases for decomposeChapter:
   - **Basic decomposition**: Given a ChapterMeta with 3 existing scenes and plot text, produces 3 SceneV5 objects with all new fields populated
   - **POV assignment**: Default pov_character matches chapter.meta.pov_character for all scenes
   - **Sensory anchors**: Each scene gets at least 2 sensory anchors
   - **Emotional arc continuity**: Scene N's exit_emotion matches Scene N+1's entry_emotion
   - **Foreshadowing mapping**: Chapter foreshadowing_plant IDs appear in at least one scene's foreshadowing.plant
   - **Transition chain**: First scene has from_previous "chapter opening", last scene has to_next containing "hook" or "ending"
   - **Merge small scenes**: Two scenes with estimated_words < merge_threshold get merged into one
   - **Max scenes cap**: Input with 7 beats results in <= 5 scenes (default max)
   - **Empty scenes array**: Returns DecompositionResult with warning when chapter has no scenes

Test cases for validateScenes:
   - **Valid scenes**: 3 well-formed SceneV5 objects return valid: true
   - **Missing sensory anchors**: Scene with 0-1 sensory_anchors returns error
   - **Bad tension_target**: Tension > 10 returns error
   - **Non-sequential numbers**: Gaps in scene_number return error
   - **Too many scenes**: 7 scenes return warning

Use fixtures: Create a minimal ChapterMeta fixture with realistic Korean content in tests/fixtures/ or inline. Use the existing Scene type from src/types.ts as base for fixture data.
  </action>
  <verify>
    - `npx vitest run tests/scene/` passes all tests
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    - Decomposer produces valid SceneV5 arrays from ChapterMeta input
    - Emotional arc continuity is enforced (exit -> entry chain)
    - Scene count respects min_chars and max_scenes constraints
    - Validator catches all constraint violations
    - All tests pass
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run validate:schemas` passes (includes new scene schema)
3. `npx vitest run tests/scene/` -- all decomposer and validator tests pass
4. Existing chapter JSONs remain valid against chapter.schema.json (no breaking changes)
</verification>

<success_criteria>
- Scene schema is a backward-compatible superset of existing chapter.scenes
- SceneV5 type extends Scene with pov_character, sensory_anchors, emotional_arc, foreshadowing, transition, style_override, exemplar_tags
- Decomposer enriches existing chapter scenes into SceneV5 using heuristics (no LLM call)
- Scene count constrained to 2-5 per chapter with merging logic
- Emotional arc continuity enforced across scene sequence
- Validator catches invalid scenes
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
