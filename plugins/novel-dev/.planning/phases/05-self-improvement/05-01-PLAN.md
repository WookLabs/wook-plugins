---
phase: 05-self-improvement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/self-improvement/types.ts
  - src/self-improvement/exemplar-collector.ts
  - src/self-improvement/index.ts
  - tests/self-improvement/exemplar-collector.test.ts
autonomous: true

must_haves:
  truths:
    - "Highest-quality passages (combinedScore >= 85 AND top 10%) are extracted from evaluated chapters"
    - "Extracted passages are classified and promoted to the Style Library as new exemplars"
    - "Duplicate passages are rejected via stylometric fingerprint similarity (threshold 0.85)"
    - "Library caps at 50 exemplars per scene_type with lowest-score eviction"
  artifacts:
    - path: "src/self-improvement/types.ts"
      provides: "ExemplarCandidate, QualitySnapshot, TrendData, RegressionAlert, CollectorConfig, TrackerConfig types"
      exports: ["ExemplarCandidate", "QualitySnapshot", "TrendAnalysis", "RegressionConfig", "CollectorConfig", "AlertLevel"]
    - path: "src/self-improvement/exemplar-collector.ts"
      provides: "Passage extraction, scoring, deduplication, and promotion pipeline"
      exports: ["extractCandidates", "promoteCandidates", "isDuplicate", "evictLowestScoring"]
    - path: "src/self-improvement/index.ts"
      provides: "Public re-exports for the self-improvement module"
    - path: "tests/self-improvement/exemplar-collector.test.ts"
      provides: "Tests for candidate extraction, scoring, dedup, promotion, eviction"
      min_lines: 80
  key_links:
    - from: "src/self-improvement/exemplar-collector.ts"
      to: "src/pipeline/quality-oracle.ts"
      via: "getParagraphs() for passage extraction"
      pattern: "getParagraphs"
    - from: "src/self-improvement/exemplar-collector.ts"
      to: "src/style-library/classifier.ts"
      via: "classifyExemplar() for auto-classification"
      pattern: "classifyExemplar"
    - from: "src/self-improvement/exemplar-collector.ts"
      to: "src/style-library/style-analyzer.ts"
      via: "computeStylometrics() for dedup fingerprinting and computeStyleMatch() for scoring"
      pattern: "computeStylometrics|computeStyleMatch"
    - from: "src/self-improvement/exemplar-collector.ts"
      to: "src/style-library/storage.ts"
      via: "addExemplar(), loadLibrary(), saveLibrary() for library mutation"
      pattern: "addExemplar|loadLibrary|saveLibrary"
---

<objective>
Create the self-improvement types and exemplar auto-accumulation pipeline that extracts the best passages from evaluated chapters, scores them, deduplicates against existing exemplars, and promotes them to the Style Library.

Purpose: Enables the Style Library to grow organically without manual curation by auto-collecting the best writing the system produces (SELF-01 requirement).
Output: Complete types module for all Phase 5 work, exemplar collector module with extraction/scoring/promotion pipeline, and comprehensive tests.
</objective>

<execution_context>
@C:\Users\jodnr\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jodnr\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-self-improvement/05-RESEARCH.md

@src/style-library/types.ts
@src/style-library/storage.ts
@src/style-library/classifier.ts
@src/style-library/style-analyzer.ts
@src/style-library/index.ts
@src/pipeline/quality-oracle.ts
@src/pipeline/types.ts
@src/quality/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create self-improvement types and exemplar collector module</name>
  <files>
    src/self-improvement/types.ts
    src/self-improvement/exemplar-collector.ts
    src/self-improvement/index.ts
  </files>
  <action>
Create `src/self-improvement/types.ts` with ALL types needed for both Plan 01 and Plan 02:

**ExemplarCandidate** (for collector):
- `content: string` (passage text, 500-2000 chars)
- `qualityScore: number` (0-100, from Quality Oracle assessment)
- `styleMatchScore: number` (0-100, from computeStyleMatch or fallback to qualityScore)
- `combinedScore: number` (0.6 * qualityScore + 0.4 * styleMatchScore)
- `category: ExemplarCategory` (from classifyExemplar)
- `sourceChapter: number`
- `paragraphRange: [number, number]` (start/end paragraph indices)

**CollectorConfig**:
- `promotionThreshold: number` (default 85 -- minimum combinedScore)
- `topPercentile: number` (default 0.1 -- top 10%)
- `maxPerSceneType: number` (default 50)
- `deduplicationThreshold: number` (default 0.85 -- stylometric similarity)
- `windowSizes: number[]` (default [2, 3, 4] -- paragraph window sizes for extraction)

**QualitySnapshot** (for tracker -- Plan 02 will use):
- `chapterNumber: number`
- `timestamp: string` (ISO 8601)
- `version: number`
- `overallScore: number` (0-100)
- `dimensions: Record<string, number>` (flexible map: proseQuality, sensoryGrounding, filterWordDensity, rhythmVariation, characterVoice, transitionQuality, honorificConsistency?, koreanTexture?, styleAlignment?)
- `verdict: 'PASS' | 'REVISE'`

**TrendAnalysis** (for regression detector -- Plan 02 will use):
- `rollingAverage: number`
- `ewma: number`
- `trendSlope: number`
- `regressionDetected: boolean`
- `alertLevel: AlertLevel`
- `alertMessage?: string`
- `dimensionTrends: Record<string, { slope: number; declining: boolean }>`

**AlertLevel**: `'none' | 'warning' | 'critical'`

**RegressionConfig**:
- `lambda: number` (EWMA smoothing, default 0.2)
- `minDataPoints: number` (default 5)
- `windowSize: number` (default 5)
- `warningThreshold: number` (z-score, default -1.5)
- `criticalThreshold: number` (z-score, default -2.0)
- `slopeWarningThreshold: number` (default -1.0)
- `slopeCriticalThreshold: number` (default -2.0)

**TrendData** (persistent storage format):
- `projectId: string`
- `snapshots: QualitySnapshot[]`
- `metadata: { totalSnapshots: number; lastUpdated: string; autoExemplarsAdded: number; regressionAlertsFired: number }`

Import ExemplarCategory from `../style-library/types.js`. Import StyleProfile from `../style-library/style-profile.js`.

Create `src/self-improvement/exemplar-collector.ts`:

1. **`extractCandidates(content, chapterNumber, qualityAssessment, styleProfile?, config?)`**:
   - Use `getParagraphs()` from `../pipeline/quality-oracle.js` to split content
   - Sliding window over paragraphs using config.windowSizes (default [2,3,4])
   - Filter passages: 500-2000 chars length constraint (per StyleExemplar schema)
   - For each valid passage:
     - Calculate qualityScore from the chapter-level QualityAssessment (use the average of: proseQuality.score, sensoryGrounding.score, rhythmVariation.score, characterVoice.score, transitionQuality.score)
     - Calculate styleMatchScore via `computeStyleMatch(passage, styleProfile).overallMatch` if profile provided, else use qualityScore as fallback
     - combinedScore = 0.6 * qualityScore + 0.4 * styleMatchScore
     - Only keep if combinedScore >= config.promotionThreshold (85)
   - Classify each candidate via `classifyExemplar(passage, { genre })`
   - Return ExemplarCandidate[] sorted by combinedScore descending

2. **`isDuplicate(candidateContent, existingExemplars, threshold?)`**:
   - Use `computeStylometrics()` from style-analyzer to fingerprint both
   - Compare stylometric similarity: normalize each metric to 0-1 range, compute Euclidean distance across 5 key metrics (TTR, MTLD, meanSentenceLength, dialogueRatio, sensoryDensity)
   - Convert distance to similarity (1 - normalizedDistance)
   - Return true if similarity > threshold (default 0.85)

3. **`evictLowestScoring(library, sceneType, maxPerType)`**:
   - Filter exemplars by scene_type matching sceneType
   - If count <= maxPerType, return library unchanged
   - Sort by: curated exemplars first (source !== 'auto-accumulated'), then by a heuristic score based on quality_notes containing numeric scores
   - Remove excess lowest-scoring auto-accumulated exemplars only (never evict source !== 'auto-accumulated')
   - Return updated library via removeExemplar()

4. **`promoteCandidates(candidates, projectDir, genre, config?)`**:
   - Load library via loadLibrary(projectDir)
   - For each candidate (already sorted by score):
     - Check isDuplicate against library.exemplars -- skip if duplicate
     - Check scene_type cap via evictLowestScoring
     - Create NewExemplarInput: content, genre: [genre], scene_type from category, emotional_tone from category, pov from category, pacing from category, is_anti_exemplar: false, source: 'auto-accumulated', quality_notes: `Auto-collected from chapter ${sourceChapter}, combinedScore: ${combinedScore.toFixed(1)}`
     - Add via addExemplar(library, input)
   - Save final library via saveLibrary(projectDir, library)
   - Return count of promoted exemplars

Create `src/self-improvement/index.ts`:
- Re-export all types from types.ts
- Re-export extractCandidates, promoteCandidates, isDuplicate, evictLowestScoring from exemplar-collector.ts
- Add comment placeholder for Plan 02 exports (quality-tracker, regression-detector)
  </action>
  <verify>
    npx tsc --noEmit --project tsconfig.json
    Verify: No type errors. All imports resolve (getParagraphs, classifyExemplar, computeStylometrics, computeStyleMatch, addExemplar, loadLibrary, saveLibrary).
  </verify>
  <done>
    - types.ts exports all types for both Plan 01 and Plan 02
    - exemplar-collector.ts exports extractCandidates, isDuplicate, evictLowestScoring, promoteCandidates
    - index.ts re-exports the public API
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for exemplar collector</name>
  <files>
    tests/self-improvement/exemplar-collector.test.ts
  </files>
  <action>
Create `tests/self-improvement/exemplar-collector.test.ts` using vitest (matching project convention).

Test groups:

**extractCandidates tests:**
- Given a chapter with 10+ paragraphs of Korean prose (use realistic Korean text fixtures 500+ chars each), extracts candidates within 500-2000 char range
- Candidates with combinedScore < 85 are filtered out
- With a StyleProfile provided, styleMatchScore uses computeStyleMatch; without, falls back to qualityScore
- combinedScore formula: verify 0.6 * qualityScore + 0.4 * styleMatchScore
- Each candidate has correct paragraphRange and sourceChapter
- Candidates are sorted by combinedScore descending

**isDuplicate tests:**
- Two identical passages return true (similarity > 0.85)
- Two very different passages return false
- Two stylistically similar but not identical passages test the threshold boundary
- Empty exemplar list returns false
- Custom threshold parameter works (0.5 vs 0.95)

**evictLowestScoring tests:**
- Library under cap returns unchanged
- Library over cap evicts auto-accumulated exemplars with lowest scores
- Curated exemplars (source !== 'auto-accumulated') are NEVER evicted
- Correct number of exemplars remain after eviction (maxPerType)

**promoteCandidates tests:**
- Uses a temp directory for file I/O (vitest's `tmpdir` or manual temp dir)
- Promotes candidates that pass dedup check
- Skips duplicate candidates
- Caps per scene_type at maxPerSceneType (default 50)
- Promoted exemplars have source: 'auto-accumulated'
- Promoted exemplars have correct quality_notes with chapter number and score
- Library file is written to disk after promotion

Use Korean text content for realistic testing -- at least 3-4 paragraphs of Korean prose per fixture (reuse patterns from existing tests in tests/ if available, otherwise create minimal Korean paragraph fixtures).
  </action>
  <verify>
    npx vitest run tests/self-improvement/exemplar-collector.test.ts
    Verify: All tests pass. Check test count >= 12 distinct test cases.
  </verify>
  <done>
    - All extractCandidates tests pass (extraction, filtering, scoring, sorting)
    - All isDuplicate tests pass (identical, different, threshold boundary)
    - All evictLowestScoring tests pass (under cap, over cap, curated protection)
    - All promoteCandidates tests pass (promotion, dedup skip, cap, file I/O)
    - 12+ test cases total
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run tests/self-improvement/` passes all tests
3. `src/self-improvement/index.ts` exports all public API functions
4. Types in types.ts cover both Plan 01 (exemplar) and Plan 02 (trend/regression) needs
</verification>

<success_criteria>
- extractCandidates correctly extracts, scores (combinedScore = 0.6*quality + 0.4*style), and filters passages from chapter content
- isDuplicate uses stylometric fingerprinting to prevent library bloat
- evictLowestScoring respects scene_type caps and never evicts curated exemplars
- promoteCandidates integrates with real Style Library storage (loadLibrary/addExemplar/saveLibrary)
- All tests pass, TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-self-improvement/05-01-SUMMARY.md`
</output>
