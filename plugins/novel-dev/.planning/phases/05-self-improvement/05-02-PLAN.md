---
phase: 05-self-improvement
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/self-improvement/quality-tracker.ts
  - src/self-improvement/regression-detector.ts
  - src/self-improvement/index.ts
  - schemas/quality-trend.schema.json
  - tests/self-improvement/quality-tracker.test.ts
  - tests/self-improvement/regression-detector.test.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Quality metrics are recorded per-chapter with all dimensional scores"
    - "Trend visualization renders as a markdown table with arrow indicators"
    - "System detects quality regression via EWMA + z-score alerting"
    - "Warning fires at z-score <= -1.5 or slope < -1.0; critical at z-score <= -2.0 or slope < -2.0"
    - "No alerts fire with fewer than 5 data points (minimum data threshold)"
    - "Superseded snapshots (old versions of rewritten chapters) are excluded from trend calculations"
  artifacts:
    - path: "src/self-improvement/quality-tracker.ts"
      provides: "Per-chapter quality recording, persistence, trend visualization"
      exports: ["recordSnapshot", "loadTrendData", "saveTrendData", "getLatestSnapshots", "renderTrendTable", "recalculateTrends"]
    - path: "src/self-improvement/regression-detector.ts"
      provides: "EWMA calculation, z-score alerting, per-dimension trend analysis"
      exports: ["detectRegression", "computeEWMA", "computeDimensionTrends", "buildAlertMessage", "DEFAULT_REGRESSION_CONFIG"]
    - path: "schemas/quality-trend.schema.json"
      provides: "JSON Schema for persistent quality trend data"
      contains: "quality-trend.schema.json"
    - path: "src/self-improvement/index.ts"
      provides: "Updated public API with tracker and detector exports"
    - path: "tests/self-improvement/quality-tracker.test.ts"
      provides: "Tests for snapshot recording, persistence, versioning, visualization"
      min_lines: 60
    - path: "tests/self-improvement/regression-detector.test.ts"
      provides: "Tests for EWMA, z-score alerts, dimension trends, edge cases"
      min_lines: 80
  key_links:
    - from: "src/self-improvement/quality-tracker.ts"
      to: "src/self-improvement/types.ts"
      via: "QualitySnapshot, TrendData types from Plan 01"
      pattern: "QualitySnapshot|TrendData"
    - from: "src/self-improvement/regression-detector.ts"
      to: "simple-statistics"
      via: "mean, standardDeviation, zScore, linearRegression for statistical analysis"
      pattern: "simple-statistics"
    - from: "src/self-improvement/quality-tracker.ts"
      to: "src/state/backup.ts"
      via: "withStateBackup() for safe trend data persistence"
      pattern: "withStateBackup"
    - from: "src/self-improvement/regression-detector.ts"
      to: "src/self-improvement/types.ts"
      via: "TrendAnalysis, RegressionConfig, AlertLevel types"
      pattern: "TrendAnalysis|RegressionConfig"
---

<objective>
Create the quality trend tracking and regression detection system that records per-chapter quality snapshots, persists them with versioning, detects quality regression via EWMA + z-score analysis, and renders markdown trend visualizations.

Purpose: Enables the user to see quality trajectory and get alerts when writing quality declines, completing the autonomous self-improvement loop (SELF-02 requirement).
Output: Quality tracker module, regression detector module, JSON schema, updated index, and comprehensive tests.
</objective>

<execution_context>
@C:\Users\jodnr\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\jodnr\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-self-improvement/05-RESEARCH.md
@.planning/phases/05-self-improvement/05-01-SUMMARY.md

@src/self-improvement/types.ts
@src/self-improvement/index.ts
@src/state/backup.ts
@src/pipeline/quality-oracle.ts
@src/pipeline/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install simple-statistics and create quality tracker, regression detector, and schema</name>
  <files>
    package.json
    schemas/quality-trend.schema.json
    src/self-improvement/quality-tracker.ts
    src/self-improvement/regression-detector.ts
    src/self-improvement/index.ts
  </files>
  <action>
**Step 1: Install dependency**
Run `npm install simple-statistics` (zero-dependency statistical library with TypeScript types included).

**Step 2: Create `schemas/quality-trend.schema.json`**
JSON Schema (draft-07) for persistent quality trend data:
- `$id`: "quality-trend.schema.json"
- `title`: "QualityTrend"
- Required: project_id (string), snapshots (array), metadata (object)
- Each snapshot: chapter_number (integer >= 1), timestamp (date-time string), version (integer >= 1), overall_score (number 0-100), dimensions (object with numeric properties: prose_quality, sensory_grounding, filter_word_density, rhythm_variation, character_voice, transition_quality, honorific_consistency, korean_texture, style_alignment -- all optional), verdict (enum: PASS, REVISE), superseded (boolean, default false)
- metadata: total_snapshots (integer), last_updated (date-time string), auto_exemplars_added (integer), regression_alerts_fired (integer)

**Step 3: Create `src/self-improvement/quality-tracker.ts`**

1. **`createEmptyTrendData(projectId)`**: Returns a new TrendData with empty snapshots and zeroed metadata.

2. **`loadTrendData(projectDir, projectId)`**:
   - Path: `{projectDir}/meta/quality-trend.json`
   - If file doesn't exist, return createEmptyTrendData(projectId)
   - Parse JSON, validate basic structure, return TrendData

3. **`saveTrendData(projectDir, trendData)`**:
   - Use `withStateBackup()` from `../state/backup.js` wrapping the write
   - Path: `{projectDir}/meta/quality-trend.json`
   - Update metadata.totalSnapshots and metadata.lastUpdated before saving
   - Write with JSON.stringify(data, null, 2)

4. **`recordSnapshot(trendData, snapshot)`**:
   - Check if a snapshot for the same chapterNumber + version already exists -- if so, skip (idempotent)
   - Check if a snapshot for the same chapterNumber with LOWER version exists -- mark it as superseded by adding `superseded: true`
   - Append the new snapshot to trendData.snapshots
   - Return updated TrendData (immutable pattern -- return new object)

5. **`getLatestSnapshots(trendData)`**:
   - Filter out superseded snapshots
   - For each chapterNumber, keep only the highest-version snapshot
   - Return sorted by chapterNumber ascending
   - This is the array used for trend calculations

6. **`renderTrendTable(trendData)`**:
   - Get latest snapshots via getLatestSnapshots
   - Build a markdown table with columns: Chapter, Score, Verdict, Prose, Sensory, Rhythm, Voice, Trend
   - Trend column: compare each chapter's score to the previous chapter's score
     - Up arrow (^) if improved by >= 3 points
     - Down arrow (v) if declined by >= 3 points
     - Dash (-) if within 3 points
     - First chapter gets no indicator
   - Add a summary row at bottom: "Average: {avg} | Best: {max} | Worst: {min}"
   - Return the markdown string

7. **`recalculateTrends(trendData)`**:
   - Get latest snapshots, sort by chapterNumber
   - Recalculate metadata counters
   - Return updated TrendData

**Step 4: Create `src/self-improvement/regression-detector.ts`**

Import from `simple-statistics`: mean, standardDeviation, zScore, linearRegression.

1. **`DEFAULT_REGRESSION_CONFIG`**: RegressionConfig constant with defaults from research (lambda: 0.2, minDataPoints: 5, windowSize: 5, warningThreshold: -1.5, criticalThreshold: -2.0, slopeWarningThreshold: -1.0, slopeCriticalThreshold: -2.0).

2. **`computeEWMA(scores, lambda)`**:
   - If empty, return 0
   - ewma = scores[0]
   - For each subsequent score: ewma = lambda * score + (1 - lambda) * ewma
   - Return final ewma

3. **`computeDimensionTrends(snapshots, windowSize)`**:
   - For each dimension key present in snapshots (prose_quality, sensory_grounding, etc.)
   - Extract the last `windowSize` values for that dimension
   - Compute linear regression slope via linearRegression([[0,v0],[1,v1],...])
   - Mark as declining if slope < -0.5
   - Return Record<string, { slope: number; declining: boolean }>

4. **`buildAlertMessage(alertLevel, zScoreValue, slope, rollingAvg, dimensionTrends)`**:
   - 'none': return undefined
   - 'warning': "Quality warning: current score is {z} standard deviations below average ({avg:.1f}). {declining dimensions list if any}."
   - 'critical': "CRITICAL quality regression: score dropped significantly (z-score: {z:.2f}, trend slope: {slope:.2f}). Declining dimensions: {list}. Consider reviewing recent chapters."
   - Include declining dimension names in Korean: proseQuality -> '문체 품질', sensoryGrounding -> '감각 묘사', etc.

5. **`detectRegression(snapshots, config?)`**:
   - Use DEFAULT_REGRESSION_CONFIG merged with provided config
   - If snapshots.length < config.minDataPoints: return { regressionDetected: false, alertLevel: 'none', rollingAverage: 0, ewma: 0, trendSlope: 0, dimensionTrends: {} }
   - Extract overallScore array from snapshots
   - Compute rollingAverage: mean of last windowSize scores
   - Compute EWMA via computeEWMA(scores, lambda)
   - Compute linear regression on last windowSize scores: linearRegression([[0,s0],[1,s1],...]).m for slope
   - Compute z-score of latest score against all-but-latest scores (historicalMean, historicalStdDev)
     - Guard: if stdDev is 0, z-score is 0 (all scores identical)
   - Determine alertLevel:
     - 'critical' if zScore <= criticalThreshold OR slope <= slopeCriticalThreshold
     - 'warning' if zScore <= warningThreshold OR slope <= slopeWarningThreshold
     - 'none' otherwise
   - Compute dimensionTrends via computeDimensionTrends
   - Build alertMessage via buildAlertMessage
   - Return TrendAnalysis

**Step 5: Update `src/self-improvement/index.ts`**
Add re-exports:
- From quality-tracker.ts: recordSnapshot, loadTrendData, saveTrendData, getLatestSnapshots, renderTrendTable, recalculateTrends
- From regression-detector.ts: detectRegression, computeEWMA, computeDimensionTrends, buildAlertMessage, DEFAULT_REGRESSION_CONFIG
  </action>
  <verify>
    npx tsc --noEmit --project tsconfig.json
    Verify: No type errors. simple-statistics is installed. All imports resolve.
  </verify>
  <done>
    - simple-statistics installed in package.json
    - quality-trend.schema.json validates trend data structure
    - quality-tracker.ts exports recordSnapshot, loadTrendData, saveTrendData, getLatestSnapshots, renderTrendTable, recalculateTrends
    - regression-detector.ts exports detectRegression, computeEWMA, computeDimensionTrends, buildAlertMessage, DEFAULT_REGRESSION_CONFIG
    - index.ts re-exports all public API
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for quality tracker and regression detector</name>
  <files>
    tests/self-improvement/quality-tracker.test.ts
    tests/self-improvement/regression-detector.test.ts
  </files>
  <action>
**Create `tests/self-improvement/quality-tracker.test.ts`** using vitest:

**recordSnapshot tests:**
- Records a new snapshot for a new chapter (appended, metadata updated)
- Recording same chapterNumber+version twice is idempotent (no duplicate)
- Recording a new version for existing chapter marks old version as superseded
- Snapshot has correct timestamp format (ISO 8601)

**getLatestSnapshots tests:**
- Returns only non-superseded, highest-version snapshots
- Multiple chapters return sorted by chapterNumber ascending
- Empty trendData returns empty array

**loadTrendData / saveTrendData tests:**
- Uses temp directory for file I/O
- Save then load round-trips correctly
- Load from non-existent file returns empty TrendData
- withStateBackup integration: if save fails mid-write, backup is restored (test by checking backup file exists)

**renderTrendTable tests:**
- Empty data returns minimal table with header only
- Single chapter shows score with no trend indicator
- Multiple chapters show correct trend arrows: ^ for improvement, v for decline, - for stable
- Summary row shows correct average, best, worst
- Output is valid markdown (starts with |, has --- separator row)

**recalculateTrends tests:**
- Recalculates metadata.totalSnapshots correctly after manual edits
- Excludes superseded snapshots from count

**Create `tests/self-improvement/regression-detector.test.ts`** using vitest:

**computeEWMA tests:**
- Empty array returns 0
- Single value returns that value
- Constant array returns that constant value (EWMA converges)
- Declining sequence: EWMA is higher than last value (smoothed)
- Lambda 0.2: verify specific known calculation (e.g., [80, 75, 70] -> verify exact EWMA)

**computeDimensionTrends tests:**
- Stable scores: all slopes near 0, none declining
- Declining prose_quality: slope is negative, marked declining
- Multiple dimensions: each tracked independently
- Window larger than data: uses all available data

**detectRegression tests:**
- Fewer than minDataPoints (5): returns alertLevel 'none', regressionDetected false
- Stable scores [80, 82, 79, 81, 80]: no regression, alertLevel 'none'
- Gradual decline [85, 80, 75, 70, 65]: alertLevel 'warning' or 'critical' depending on severity
- Sharp drop [80, 80, 80, 80, 40]: alertLevel 'critical' (extreme z-score)
- Improving scores [60, 65, 70, 75, 80]: no regression
- All identical scores [80, 80, 80, 80, 80]: no regression (stdDev = 0 guard)
- Custom config: different thresholds change alert levels

**buildAlertMessage tests:**
- 'none' alert returns undefined
- 'warning' includes "Quality warning" text and z-score info
- 'critical' includes "CRITICAL" text and declining dimension names in Korean
- Declining dimensions are listed by their Korean names

Helper: Create a `makeSnapshot(chapter, score, dims?)` factory function at top of test file to reduce boilerplate. Use overallScore as the main test variable, with dimensions as optional.
  </action>
  <verify>
    npx vitest run tests/self-improvement/quality-tracker.test.ts tests/self-improvement/regression-detector.test.ts
    Verify: All tests pass. Check test count >= 20 distinct test cases across both files.
  </verify>
  <done>
    - quality-tracker tests: recordSnapshot (4 cases), getLatestSnapshots (3 cases), load/save (3 cases), renderTrendTable (4 cases), recalculateTrends (1 case) = 15+ tests
    - regression-detector tests: computeEWMA (4 cases), computeDimensionTrends (3 cases), detectRegression (6 cases), buildAlertMessage (3 cases) = 16+ tests
    - All 30+ tests pass
    - Edge cases covered: empty data, identical scores, sharp drops, custom configs
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run tests/self-improvement/` passes ALL tests (both Plan 01 and Plan 02 tests)
3. `npm ls simple-statistics` shows installed dependency
4. `schemas/quality-trend.schema.json` is valid JSON Schema
5. `src/self-improvement/index.ts` re-exports the complete public API for both exemplar collection and quality tracking
</verification>

<success_criteria>
- Quality snapshots are recorded per-chapter with dimensional scores and version tracking
- Superseded snapshots (old versions of rewritten chapters) are correctly excluded from trend calculations
- EWMA regression detection fires warnings at z <= -1.5 and criticals at z <= -2.0
- Trend visualization renders a readable markdown table with arrow indicators
- simple-statistics is used for mean, standardDeviation, zScore, linearRegression (not hand-rolled)
- withStateBackup protects trend data writes
- All tests pass, TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-self-improvement/05-02-SUMMARY.md`
</output>
