---
name: rtl-plan
description: RTL 수정 계획을 수립하고 line-by-line diff와 수정 후 타이밍 다이어그램을 제시
user-invocable: true
allowed-tools:
  - Read
  - Glob
  - Grep
  - Bash
  - AskUserQuestion
---

# RTL Plan

RTL 수정 계획을 수립한다. 수정 전/후 코드 비교, 수정 후 타이밍 다이어그램, Top-Down 수정 순서를 제시하고 사용자 승인을 받는다.

**이 스킬은 계획만 수립한다. 분석은 `/rtl-analyze`, 적용은 `/rtl-apply`에서 한다.**

## Input

```
/rtl-plan <수정 대상> <수정 목적>
```

- `/rtl-analyze` 결과를 기반으로 호출하는 것을 권장한다
- 직접 호출 시 대상 파일/모듈과 수정 목적을 명시한다

## Core Principle

**RTL은 소프트웨어가 아니다. 모든 로직에는 명분과 이유가 있어야 한다.**

수정 계획 수립 전 스스로 확인해야 할 항목:

| 체크 | 질문 |
|------|------|
| ☐ | 이 수정의 명확한 이유가 있는가? |
| ☐ | 수정 전/후 타이밍 다이어그램을 그릴 수 있는가? |
| ☐ | 이 수정이 다른 경로에 영향을 주는가? |
| ☐ | 합성 결과(면적, 타이밍)에 미치는 영향은? |
| ☐ | 더 단순한 해결책은 없는가? |

## Execution Flow

### Phase 1: 수정 범위 결정

1. 수정이 필요한 파일/라인을 식별한다
2. 다중 파일 수정 시, Top-Down 순서를 결정한다:
   - Wrapper (포트 고정) → IP Top → 하위 모듈 순서
   - 각 수정을 독립적인 단위로 분리한다
3. 수정의 영향 범위를 확인한다 (fanout, CDC, 인스턴스)

### Phase 2: 수정 제안 작성

각 수정 단위에 대해 아래 형식으로 제안서를 작성한다.

**제안 코드는 반드시 `/rtl-format` 규칙을 따른다.** 사용자가 승인하는 코드가 최종 적용 결과와 동일해야 하므로, 제안서의 "수정 내용" 코드에 아래 규칙을 적용한다:
- 2-space 들여쓰기 (Rule 1)
- `if(` 붙여쓰기 (Rule 2)
- 2의 배수 정렬 그리드 (Rule 3)
- 포트 선언 세로정렬 — 인스턴스 파생 (Rule 4)
- 신호 선언 세로정렬 (Rule 5)
- 인스턴스 포트 연결 세로정렬 (Rule 6)
- one-liner if-else 세로정렬 (Rule 7)
- 1-bit 컨텍스트에서 `||`→`|`, `&&`→`&` (Rule 8)
- trailing whitespace 제거 (Rule 9)
- 파일 끝 빈 줄 1개 (Rule 10)
- 변수 선언 최초 사용 블럭 위 (Rule 11)
- 조합식 wire 분리 (Rule 16)

## Modification Proposal Format

**다중 수정 시, 반드시 각각 별도 제안으로 분리한다. 한 번에 하나씩 승인받는다.**

```
┌─────────────────────────────────────────────────────────────┐
│  [수정 제안 1/N]                                              │
│                                                               │
│  대상 파일: qs_mipi_txl_xxxxx.v                               │
│  대상 라인: Line 123-125                                      │
│                                                               │
│  문제 분석:                                                    │
│    현재 o_valid가 i_valid와 동일 사이클에 발생하여              │
│    downstream 모듈이 데이터를 놓치는 문제 발생                  │
│                                                               │
│  현재 동작 (타이밍):                                           │
│    clk     ┌─┐ ┌─┐ ┌─┐                                       │
│            ┘ └─┘ └─┘ └─                                       │
│    i_valid ──┐▓▓▓▓▓▓▓▓                                       │
│    o_valid ──┐▓▓▓▓▓▓▓▓  ← 문제: 동시 발생                    │
│                                                               │
│  수정 내용:                                                    │
│    - 기존: assign o_valid = i_valid;                          │
│    + 수정: always @(posedge clk) r_valid <= i_valid;          │
│           assign o_valid = r_valid;                           │
│                                                               │
│  수정 후 동작 (타이밍):                                        │
│    clk     ┌─┐ ┌─┐ ┌─┐                                       │
│            ┘ └─┘ └─┘ └─                                       │
│    i_valid ──┐▓▓▓▓▓▓▓▓                                       │
│    o_valid ────┐▓▓▓▓▓▓  ← 1-cycle 지연                       │
│                                                               │
│  수정 이유:                                                    │
│    Downstream 모듈이 valid를 샘플링할 시간 확보                │
│                                                               │
│  영향 범위:                                                    │
│    - 전체 latency 1-cycle 증가                                │
│    - 다른 경로에 영향 없음                                     │
│                                                               │
│  승인하시겠습니까? (승인/거부/질문)                              │
└─────────────────────────────────────────────────────────────┘
```

### Phase 3: 사용자 승인

AskUserQuestion으로 승인을 받는다.

| 사용자 응답 | 동작 |
|-------------|------|
| "승인", "OK", "진행", "ㅇㅇ", "고" | plan 확정, `/rtl-apply`로 안내 |
| "거부", "안됨", "다시", "NO" | 대안 제시 |
| 질문 | 추가 설명 제공 |

## Multi-File Modification Order

다중 파일 수정 시 Top-Down 순서를 따른다:

```
수정 1/N: [최상위 모듈] → 승인 대기
         ↓ 승인 후
수정 2/N: [중간 모듈]   → 승인 대기
         ↓ 승인 후
수정 N/N: [최하위 모듈] → 승인 대기
         ↓ 전체 승인 후
→ /rtl-apply 로 적용
```

**포트 추가/수정 시 순서 규칙:**
- Wrapper 포트 선언: 수정 금지 (외부 인터페이스 고정)
- Wrapper 내부 인스턴스 연결: 수정 가능 (시작점)
- 하위 모듈: Top-Down 순서로 수정

## Prohibited Modifications

| 금지 항목 | 이유 |
|-----------|------|
| 이유 없는 로직 추가 | 게이트 낭비, 타이밍 악화 |
| "혹시 모르니까" 식 방어 코드 | 불필요한 복잡도 |
| 검증 안 된 최적화 | 기능 오류 위험 |
| 다중 수정 동시 적용 | 문제 발생 시 원인 추적 불가 |
| 사용자 미승인 수정 | 설계 의도 훼손 |

## Constraints

- **수정하지 않는다** — 계획과 제안만 한다
- **타이밍 다이어그램 필수** — 수정 전/후 모두 타이밍 다이어그램을 포함한다
- **한 번에 하나씩** — 다중 수정은 반드시 개별 제안으로 분리한다
- **승인 필수** — 모든 제안에 대해 명시적 승인을 받는다
- **금지 사항 준수** — 위 금지 항목에 해당하는 수정은 제안하지 않는다
- **Format 준수** — 제안 코드는 `/rtl-format` 규칙을 따라야 한다. 사용자가 보는 코드 = 최종 적용 코드
