---
name: rtl-change-protocol
description: RTL 변경 승인 프로토콜. 모든 RTL 수정은 이 워크플로우를 반드시 거쳐야 함.
allowed-tools: Read, AskUserQuestion
---

# RTL Change Protocol

RTL 코드 변경을 위한 필수 승인 프로토콜.

## 핵심 원칙

**RTL은 소프트웨어가 아니다. 하드웨어다.**

- 모든 신호 변경은 물리적 타이밍에 영향을 준다
- 방어 로직이 없다 - 모든 게이트는 목적이 있다
- 변경에는 반드시 명분과 이유가 필요하다

## Iron Law

**"문서 승인 없이 RTL 수정 없다"**

모든 RTL 변경은 반드시 변경 문서를 먼저 작성하고, 사용자 승인을 받은 후에만 코드를 수정한다.

## 필수 워크플로우

모든 RTL 변경은 다음 **문서 기반 워크플로우**를 반드시 거쳐야 한다:

### Step 1: 변경 문서 작성

`docs/changes/{date}-{title}.md` 파일을 생성하고 다음 템플릿으로 작성:

```markdown
# 변경 요청: {title}

## 상태: DRAFT

## 변경 이유

**문제점**: [현재 무엇이 문제인가?]
**원인**: [왜 이 문제가 발생하는가?]
**해결책**: [어떻게 해결할 것인가?]
**명분**: [왜 이 변경이 정당한가?]

## BEFORE 타이밍 다이어그램

         cycle  1    2    3    4    5    6    7    8
                │    │    │    │    │    │    │    │
   clk      ────┴────┴────┴────┴────┴────┴────┴────┴────

   valid    ____/‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\________________

   data     ====<D0  ><D1  ><D2  ><D3  ><D4  >=========

   ready    ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\____/‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾

   문제 지점: [문제가 발생하는 시점 설명]

## AFTER 타이밍 다이어그램

         cycle  1    2    3    4    5    6    7    8
                │    │    │    │    │    │    │    │
   clk      ────┴────┴────┴────┴────┴────┴────┴────┴────

   valid    ____/‾‾‾‾‾‾‾‾‾‾‾‾\____/‾‾‾‾‾‾‾‾‾‾‾‾\______

   data     ====<D0  ><D1  ><D2  >====<D3  ><D4  >====

   ready    ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\____/‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾

   개선점: [변경 후 개선되는 부분 설명]

## 영향 분석

### 직접 영향받는 모듈
| 모듈 | 영향 | 위험도 |
|------|------|--------|
| [모듈명] | [영향 설명] | LOW/MEDIUM/HIGH/CRITICAL |

### 타이밍 영향
- 크리티컬 패스 변화: [설명]
- 레이턴시 변화: [설명]
- 스루풋 변화: [설명]

### 검증 필요 항목
- [ ] [테스트 항목 1]
- [ ] [테스트 항목 2]
- [ ] [테스트 항목 3]

## 변경 내용

### 파일: [파일명]

**변경 전:**
```verilog
[기존 코드]
```

**변경 후:**
```verilog
[변경된 코드]
```

**변경 설명:** [왜 이렇게 변경하는지 설명]
```

### Step 2: 사용자 리뷰

문서 작성 완료 후, 사용자에게 리뷰 요청:

```
## 변경 문서 작성 완료

문서 위치: docs/changes/{date}-{title}.md

**변경 요약**: [한 줄 요약]
**영향 범위**: [파일/모듈 목록]
**위험도**: [LOW/MEDIUM/HIGH/CRITICAL]

다음 명령어로 응답해주세요:
- /approve-change : 변경 승인 및 RTL 수정 진행
- /reject-change --reason "사유" : 변경 거부
- 문서 수정 요청 시: 구체적인 피드백 제공
```

### Step 3: 문서 승인 (`/approve-change`)

사용자가 `/approve-change` 명령 실행 시:
1. 문서 상태를 `DRAFT` → `APPROVED`로 변경
2. 승인 타임스탬프 및 승인자 기록
3. Step 4로 진행

### Step 4: RTL 수정 (승인된 문서 기반)

승인된 문서에 기록된 변경 내용을 **정확히** 반영하여 RTL 파일 수정:
1. 문서에 명시된 파일만 수정
2. 문서에 명시된 변경 내용만 적용
3. 추가 변경이 필요하면 새로운 변경 문서 작성

## 관련 커맨드

### RTL 변경 관련
```bash
/approve-change                    # RTL 변경 문서 승인 및 코드 수정 진행
/approve-change --comment "조건"   # 조건부 승인
/reject-change --reason "사유"     # RTL 변경 거부
/show-pending                      # 보류 중인 변경 확인
```

### 스펙 문서 관련
```bash
/approve-spec                      # 스펙 문서 승인
/reject-spec --reason "사유"       # 스펙 문서 거부
```

## 금지 사항

다음은 **절대로** 허용되지 않음:

1. 변경 문서 작성 없이 RTL 변경 제안
2. 타이밍 다이어그램 없이 RTL 변경 제안
3. 이유/명분 없이 RTL 변경 제안
4. 영향 분석 없이 RTL 변경 제안
5. **사용자 승인 없이 RTL 파일 수정**
6. 승인된 문서 범위를 벗어난 코드 수정

## 예외

없음. **모든** RTL 변경은 이 문서 기반 워크플로우를 따라야 함.

## 변경 문서 템플릿 전체 예시

```markdown
# 변경 요청: AXI Valid-Ready 백프레셔 처리 개선

## 상태: DRAFT

## 변경 이유

**문제점**: 백프레셔 상황에서 valid 신호가 유지되어 데이터 손실 가능
**원인**: ready 신호와 valid 신호 간 동기화 로직 부재
**해결책**: ready 하강 시 valid도 함께 하강시키고, 재전송 로직 추가
**명분**: AXI 프로토콜 준수 및 데이터 무결성 보장

## BEFORE 타이밍 다이어그램

         cycle  1    2    3    4    5    6    7    8
                │    │    │    │    │    │    │    │
   clk      ────┴────┴────┴────┴────┴────┴────┴────┴────

   valid    ____/‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\________________

   data     ====<D0  ><D1  ><D2  ><D3  ><D4  >=========

   ready    ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\____/‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾

   문제 지점: cycle 4에서 ready가 떨어지지만 valid는 유지됨
             → D3 데이터가 손실될 수 있음

## AFTER 타이밍 다이어그램

         cycle  1    2    3    4    5    6    7    8
                │    │    │    │    │    │    │    │
   clk      ────┴────┴────┴────┴────┴────┴────┴────┴────

   valid    ____/‾‾‾‾‾‾‾‾‾‾‾‾\____/‾‾‾‾‾‾‾‾‾‾‾‾\______

   data     ====<D0  ><D1  ><D2  >====<D3  ><D4  >====

   ready    ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\____/‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾

   개선점: ready가 떨어지면 valid도 함께 떨어짐
          → backpressure 시 데이터 전송 중단
          → ready 복구 후 재전송

## 영향 분석

### 직접 영향받는 모듈
| 모듈 | 영향 | 위험도 |
|------|------|--------|
| data_fifo | valid 타이밍 변경 | MEDIUM |
| downstream_ctrl | backpressure 처리 필요 | HIGH |

### 타이밍 영향
- 크리티컬 패스 변화: 없음
- 레이턴시 변화: +1 cycle (worst case)
- 스루풋 변화: backpressure 시 감소

### 검증 필요 항목
- [ ] data_fifo overflow 테스트
- [ ] backpressure stress 테스트
- [ ] 경계 조건 테스트

## 변경 내용

### 파일: rtl/axi_master.v

**변경 전:**
```verilog
always @(posedge clk) begin
    if (start)
        valid <= 1'b1;
    else if (done)
        valid <= 1'b0;
end
```

**변경 후:**
```verilog
always @(posedge clk) begin
    if (start)
        valid <= 1'b1;
    else if (done || (!ready && valid))
        valid <= 1'b0;
end
```

**변경 설명:** ready 하강 시 valid를 즉시 클리어하여 백프레셔 처리
```
